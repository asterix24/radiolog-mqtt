{{define "head"}}
<style>
    .ok {
        color: green;
    }
</style>
{{end}}


{{define "content"}}
<div class="row">
    <div class="col-sm-3">
        <div class="card border-primary mb-3">
            <div class="card-header">Send MQTT Message</div>
            <div class="card-body text-primary">
                <h5 class="card-title" id="status" class="hello">Status: -</h5>
                <p class="card-text">
                    <button id="click" type="button" class="btn btn-primary btn-lg btn-block" data-toggle="button"
                        aria-pressed="false" autocomplete="off" name="smile"><i class="far fa-smile"></i></button>
                    <button id="click" type="button" class="btn btn-primary btn-lg btn-block" data-toggle="button"
                        aria-pressed="false" autocomplete="off" name="cross"><i class="fas fa-times"></i></button>
                    <button id="click" type="button" class="btn btn-primary btn-lg btn-block" data-toggle="button"
                        aria-pressed="false" autocomplete="off" name="flushed"><i class="far fa-flushed"></i></button>
                    <button id="click" type="button" class="btn btn-primary btn-lg btn-block" data-toggle="button"
                        aria-pressed="false" autocomplete="off" name="tre">tre</button>
                </p>
            </div>
        </div>
    </div>
    <div class="col-sm-8">
        <div class="card border-primary mb-3">
            <div class="card-header">Devices Status</div>
            <div class="card-body text-primary">
                <div class="row">
                    <div class="col-sm-4">
                        <h5 class="card-title">Status</h5>
                        <button type="button" class="btn btn-danger" id="dev_status">OFFLINE</button>
                    </div>
                    <div class="col-sm-4">
                        <h5 class="card-title">Connection</h5>
                        <button type="button" class="btn btn-secondary" id=recon>Refresh</button>
                    </div>
                </div>
                <p class="card-text">
                    <table class="table" id=dev_table>
                        <thead class="thead-light">
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col">Timestamp</th>
                                <th scope="col">Node</th>
                                <th scope="col">Status</th>
                                <th scope="col">Uptime</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </p>
            </div>
        </div>
    </div>
</div>
{{end}}

{{ define "javascript"}}
<script type="text/javascript">

    function editTableElement(table, key, value, timestamp) {
        var ret = false;
        table.find("tr").each(function (rowIndex, r) {
            var sameNode = false;
            $(this).find("td").each(function (colIndex, c) {
                if (c.textContent === key) {
                    sameNode = true;
                }
                if (sameNode && colIndex == 3) {
                    c.textContent = value;
                    ret = true;
                }
                if (sameNode && colIndex == 0) {
                    c.textContent = timestamp;
                }
            });
            if (ret) {
                $(this).addClass("table-success");
            }
        });
        return ret;
    }

    function cleanTableStatus() {
        $("#dev_table").find("tr").each(function (rowIndex, r) {
            $(this).removeClass("table-success");
        });
    }

    function appendTableColumn(table, rowData) {
        var lastRow = $('<tr/>').appendTo(table.find('tbody:last'));
        $.each(rowData, function (colIndex, c) {
            lastRow.append($("<t" + (colIndex == 0 ? "h" : "d") + "/>").text(c));
        });

        return lastRow;
    }

    function devicesStatus() {
        var ws = new WebSocket("{{.url}}");
        ws.onopen = function (evt) {
            $("#dev_status").text("OPEN");
            $("#dev_status").removeClass("btn-danger");
            $("#dev_status").addClass("btn-success");
        }

        ws.onclose = function (evt) {
            $("#dev_status").text("CLOSE");
            $("#dev_status").removeClass("btn-success");
            $("#dev_status").addClass("btn-danger");
            ws = null;
        }

        ws.onmessage = function (evt) {
            var d = JSON.parse(evt.data)
            var edit = editTableElement($("#dev_table"), d.node, d.data, d.timestamp);
            if (!edit) {
                appendTableColumn($("#dev_table"), [$("#dev_table tr").length, d.timestamp, d.node, "alive", d.data]);
            }
        }

        ws.onerror = function (evt) {
            $("#dev_status").text("ERROR");
            $("#dev_status").removeClass("btn-success");
            $("#dev_status").addClass("btn-danger");
        }
    }

    $("#recon").on("click", function () {
        devicesStatus();
    });


    $("button#click").click(function () {
        var cur = $(this);
        $.ajax({
            type: "POST",
            url: "event",
            data: JSON.stringify({ icons: $(this).attr("name"), status: "ok" }),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (msg) {
                $("#status").attr("class", "ok");
                $("#status").text("Status: " + cur.attr("name") + "..ok!");
            },
            error: function (msg) {
                $("#status").text("Error!");
            }
        });
    });

    devicesStatus();
    setInterval(cleanTableStatus, 5000);

</script>
{{end}}